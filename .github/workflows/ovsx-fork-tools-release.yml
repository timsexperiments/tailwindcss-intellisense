# This workflow automatically creates a git tag when a version change is detected in package.json.
# It runs on pushes to the main/master branch.
name: Auto Tag Release
on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

concurrency:
  group: auto-tag-${{ github.ref }}
  cancel-in-progress: false

jobs:
  tag-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      tag: ${{ steps.version.outputs.tag }}
      created: ${{ steps.tag.outputs.created }}
    env:
      EXTENSION_PATH: packages/vscode-tailwindcss
      PUBLISHER_NAME: TimsExperiments
      OPEN_VSX_TOKEN: ${{ secrets.OPEN_VSX_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Reads package.json, calculates the expected tag format (vX.Y.Z), and outputs it.
      # We need to know the current version in package.json to determine if a tag is missing.
      - name: Get Version and Tag
        id: version
        run: |
          cd ${{ env.EXTENSION_PATH }} || exit 1
          VERSION=$(jq -r .version package.json)

          if [ "${{ env.EXTENSION_PATH }}" == "." ] || [ "${{ env.EXTENSION_PATH }}" == "./" ]; then
            TAG="v$VERSION"
          else
            # Clean path for tag name (remove leading ./ and trailing /)
            CLEAN_PATH=$(echo "${{ env.EXTENSION_PATH }}" | sed 's/^\.\///' | sed 's/\/$//')
            TAG="$CLEAN_PATH/v$VERSION"
          fi

          echo "Detected version: $VERSION"
          echo "Calculated tag: $TAG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      # Checks if the calculated tag exists. If not, creates and pushes it.
      # This ensures we only create tags that don't exist yet, avoiding errors and duplicate releases.
      - name: Check and Push Tag
        id: tag
        env:
          TAG: ${{ steps.version.outputs.tag }}
        run: |
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists. Skipping."
            echo "created=false" >> $GITHUB_OUTPUT
          else
            echo "Tag $TAG does not exist. Creating..."
            git config user.name "GitHub Action"
            git config user.email "action@github.com"
            git tag -a "$TAG" -m "Release $TAG"
            git push origin "$TAG"
            echo "created=true" >> $GITHUB_OUTPUT
          fi

  release:
    needs: tag-version
    if: needs.tag-version.outputs.created == 'true'
    runs-on: ubuntu-latest
    env:
      EXTENSION_PATH: packages/vscode-tailwindcss
      PUBLISHER_NAME: TimsExperiments
      OPEN_VSX_TOKEN: ${{ secrets.OPEN_VSX_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.tag-version.outputs.tag }}

      - name: Detect pnpm version
        id: detect-pnpm
        run: |
          if [ -f package.json ] && grep -q '"packageManager":' package.json; then
            echo "packageManager found in package.json"
            echo "version=" >> $GITHUB_OUTPUT
          else
            echo "packageManager not found, using default"
            echo "version=10" >> $GITHUB_OUTPUT
          fi

      - uses: pnpm/action-setup@v4
        with:
          version: ${{ steps.detect-pnpm.outputs.version }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: "pnpm"

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Everything
        run: pnpm -r run build

      # Updates the 'publisher' field in package.json to match the environment variable.
      # The upstream package.json has the original publisher. We need to publish under YOUR publisher ID.
      - name: Patch to ${{ env.PUBLISHER_NAME }}
        run: |
          cd ${{ env.EXTENSION_PATH }}

          jq '.publisher = "${{ env.PUBLISHER_NAME }}"' package.json > package.json.tmp && mv package.json.tmp package.json

          echo "Publisher verified as:"
          grep '"publisher":' package.json

      # Runs 'vsce package' to create the file and 'ovsx publish' to upload it.
      # This creates the .vsix artifact and uploads it to the OpenVSX registry.
      - name: Build & Publish
        env:
          OVSX_PAT: ${{ env.OPEN_VSX_TOKEN }}
        run: |
          cd ${{ env.EXTENSION_PATH }}

          pnpm dlx vsce package

          pnpm dlx ovsx publish -p $OVSX_PAT
